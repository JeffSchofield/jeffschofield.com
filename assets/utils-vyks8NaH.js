var x=Object.defineProperty;var F=(e,t,r)=>t in e?x(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var f=(e,t,r)=>F(e,typeof t!="symbol"?t+"":t,r);import{g as U}from"./index-CvEWBL4J.js";function P(e,t,r){let a=e.createProgram();if(!a)throw new Error("Unable to create program");if(e.attachShader(a,t),e.attachShader(a,r),e.linkProgram(a),!e.getProgramParameter(a,e.LINK_STATUS))throw new Error("Unable to create program");return a}function R(e,t,r){let a=e.createShader(t);if(!a)throw new Error("Unable to create shader");if(e.shaderSource(a,r),e.compileShader(a),!e.getShaderParameter(a,e.COMPILE_STATUS))throw console.log(r),console.error(e.getShaderInfoLog(a)),new Error("Unable to compile shader");return a}function T(e,t,r,a){const s=e.getUniformLocation(t,a);return function(...i){if(s)return e.useProgram(t),e[`uniform${r}`](s,...i)}}function S(e,t,r){return e.getAttribLocation(t,r)}var c=new Map;function v(e,t){let r=c.get(e)||[];c.set(e,[...r,t])}function C(e){for(let t of c.get(e)||[])e.deleteBuffer(t);c.set(e,[])}function N(e,t){let r=c.get(e)||[],a=r.indexOf(t);a!=-1&&(e.deleteBuffer(t),r.splice(a,1),c.set(e,r))}function q(e,t,r=e.STATIC_DRAW){const a=e.createBuffer();if(!a)throw new Error("Unable to create buffer");return e.bindBuffer(e.ARRAY_BUFFER,a),e.bufferData(e.ARRAY_BUFFER,t,r),v(e,a),a}function G(e,t,r,a,s){e.bindBuffer(e.ARRAY_BUFFER,t),e.drawArrays(r,a,s)}var l=new Map;function M(e,t){let r=l.get(e)||[];l.set(e,[...r,t])}function O(e){for(let t of l.get(e)||[])e.deleteFramebuffer(t);l.set(e,[])}function k(e){let t=e.createFramebuffer();if(!t)throw new Error("Unable to create framebuffer");return M(e,t),t}function W(e,t,r,a){e.bindFramebuffer(e.FRAMEBUFFER,t),e.framebufferTexture2D(e.FRAMEBUFFER,r,e.TEXTURE_2D,a,0);const s=e.checkFramebufferStatus(e.FRAMEBUFFER);if(s!==e.FRAMEBUFFER_COMPLETE)throw new Error(`Framebuffer incomplete: 0x${s.toString(16)}`)}var p=new Map;function B(e,t){let r=p.get(e)||new Set;r.add(t),p.set(e,r)}function $(e){for(let t of p.get(e)||new Set)e.deleteTexture(t);p.set(e,new Set)}function j(e,t,r,a,s,n,i=null){let o=e.createTexture();if(!o)throw new Error("Unable to create texture");return e.bindTexture(e.TEXTURE_2D,o),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,a,t,r,0,s,n,i),B(e,o),o}function V(e,t,r){e.activeTexture(t),e.bindTexture(e.TEXTURE_2D,r)}var y=(e,...t)=>e.map((r,a)=>`${r}${t[a]||""}`).join(""),L=y`#version 300 es

precision highp float;

void main() {
	float x = float((gl_VertexID & 1) << 2);
	float y = float((gl_VertexID & 2) << 1);
	gl_Position = vec4(x - 1.0, y - 1.0, 0, 1);
}
`,D=()=>({devicePixelRatio:window&&window.devicePixelRatio||1,context:{premultipliedAlpha:!1}});function w(...e){const t={};for(let r of e)for(let a in r){let s=r[a];typeof s=="object"&&s!==null?t[a]=w(t[a]||{},r[a]):t[a]=s}return t}function Y(e,t,r,a={}){const{devicePixelRatio:s,context:n}=w(D(),a),i=e.getContext("webgl2",n);if(!i)throw new Error("Unable to get WebGL context.");const o=b(i,t,r),{setResolution:u}=o;function d(_=!0){if(!i)return{};i.bindFramebuffer(i.FRAMEBUFFER,null),i.clearColor(0,0,0,0),i.clear(i.COLOR_BUFFER_BIT);const E=e.getBoundingClientRect(),h=e.width=E.width*s,m=e.height=E.height*s;return i.viewport(0,0,h,m),u([h,m]),_&&i.drawArrays(i.TRIANGLE_FAN,0,3),{width:h,height:m,ratio:h/m}}function A(){if(!i)return;let _=i.getExtension("WEBGL_lose_context");_&&_.loseContext()}return{...o,render:d,destroy:A}}function b(e,t,r){const a=R(e,e.VERTEX_SHADER,t),s=R(e,e.FRAGMENT_SHADER,r),n=P(e,a,s);if(!n)throw new Error("Unable to create shader program");const i=T(e,n,"2fv","resolution");return e.useProgram(n),{gl:e,program:n,vertex_shader:a,fragment_shader:s,createUniform:(o,u)=>T(e,n,o,u),createAttribute:o=>S(e,n,o),setResolution:i}}function z(e,t){return{...b(e,L,t),draw(){e.drawArrays(e.TRIANGLE_FAN,0,3)}}}var H=class{constructor(){f(this,"program_states",new Map);f(this,"program_inits",new Map);f(this,"program_updates",new Map);f(this,"program_renders",new Map);f(this,"program_destroys",new Map);f(this,"state",0);f(this,"last_loop_time",0);f(this,"update_speed",1);f(this,"update_time_step",16);f(this,"max_updates",200);f(this,"animation_frame");f(this,"accumulated_frame_time",0)}linkProgram(e){if(this.program_states.set(e,0),e.init){const t=async()=>{let r=e.init();(!r||!r.then)&&(r=Promise.resolve(r)),await r,this.program_states.set(e,1),e.update&&this.program_updates.set(e,e.update),e.render&&this.program_renders.set(e,e.render)};this.program_inits.set(e,t),[1,2].includes(this.state)&&t()}e.destroy&&this.program_destroys.set(e,()=>{this.program_states.get(e)==1&&(this.program_updates.delete(e),this.program_renders.delete(e),e.destroy(),this.program_states.set(e,2))})}unlinkProgram(e){this.program_states.delete(e),this.program_inits.delete(e),this.program_updates.delete(e),this.program_renders.delete(e),this.program_destroys.delete(e)}async init(){if([0,3].includes(this.state)){this.last_loop_time=performance.now(),this.state=1;try{await Promise.all(Array.from(this.program_inits.values()).map(e=>e()))}catch(e){throw console.log(e),new Error("Error initializing")}this.requestLoop()}}requestLoop(){this.animation_frame=requestAnimationFrame(this.loop.bind(this))}cancelLoop(){this.animation_frame&&cancelAnimationFrame(this.animation_frame)}loop(e){if([0,3].includes(this.state))return;if(this.state==1)for(this.accumulated_frame_time+=e-this.last_loop_time,Math.floor(this.accumulated_frame_time/this.update_time_step)>this.max_updates&&(this.accumulated_frame_time=this.update_time_step);this.accumulated_frame_time>=this.update_time_step;)this.update(this.update_time_step),this.accumulated_frame_time-=this.update_time_step;let t=this.accumulated_frame_time/this.update_time_step;this.render(t),this.last_loop_time=e,this.requestLoop()}update(e){this.program_updates.forEach(t=>t(e*this.update_speed))}render(e){this.program_renders.forEach(t=>t(e))}};function K(e,t,r,a,s,n){const i=Array.from({length:16}),o=1/(e-t),u=1/(r-a),d=1/(s-n);return i[0]=-2*o,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=-2*u,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=2*d,i[11]=0,i[12]=(e+t)*o,i[13]=(a+r)*u,i[14]=(n+s)*d,i[15]=1,i}function J(e){let t=Math.floor(Math.sqrt(e));for(let r of Array.from({length:t},(a,s)=>t-s))if(e%r==0)return[r,Math.floor(e/r)]}function Q(e,t){let r=e.value;e.value=t.value,t.value=r}function Z(e,t,{flush:r="sync",deep:a=!1,immediate:s=!0}={}){return U(e,n=>{t(n)},{flush:r,deep:a,immediate:s})}export{H as L,z as a,V as b,q as c,G as d,J as e,W as f,y as g,b as h,$ as i,O as j,Q as k,j as l,k as m,Y as n,K as o,N as p,C as r,Z as s};
