var x=Object.defineProperty;var F=(e,t,r)=>t in e?x(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var o=(e,t,r)=>F(e,typeof t!="symbol"?t+"":t,r);import{g as U}from"./index-NEwBzf1q.js";function R(...e){const t={};for(let r of e)for(let a in r){let n=r[a];typeof n=="object"&&n!==null?t[a]=R(t[a]||{},r[a]):t[a]=n}return t}function S(e){return e!=null&&typeof e=="object"&&e.buffer instanceof ArrayBuffer&&typeof e.byteLength=="number"}function y(e,t,r){let a=e.createProgram();if(!a)throw new Error("Unable to create program");if(e.attachShader(a,t),e.attachShader(a,r),e.linkProgram(a),!e.getProgramParameter(a,e.LINK_STATUS))throw new Error("Unable to create program");return a}function T(e,t,r){let a=e.createShader(t);if(!a)throw new Error("Unable to create shader");if(e.shaderSource(a,r),e.compileShader(a),!e.getShaderParameter(a,e.COMPILE_STATUS))throw console.log(r),console.error(e.getShaderInfoLog(a)),new Error("Unable to compile shader");return a}function b(e,t,r,a){const n=e.getUniformLocation(t,a);return function(...s){if(n)return e.useProgram(t),e[`uniform${r}`](n,...s)}}function P(e,t,r){return e.getAttribLocation(t,r)}var _=new Map;function B(e,t){let r=_.get(e)||[];_.set(e,[...r,t])}function N(e){for(let t of _.get(e)||[])e.deleteBuffer(t);_.set(e,[])}function q(e,t){let r=_.get(e)||[],a=r.indexOf(t);a!=-1&&(e.deleteBuffer(t),r.splice(a,1),_.set(e,r))}function O(e,t,r=e.STATIC_DRAW){const a=e.createBuffer();if(!a)throw new Error("Unable to create buffer");return e.bindBuffer(e.ARRAY_BUFFER,a),e.bufferData(e.ARRAY_BUFFER,t,r),B(e,a),a}function G(e,t,r,a,n){e.bindBuffer(e.ARRAY_BUFFER,t),e.drawArrays(r,a,n)}var p=new Map;function M(e,t){let r=p.get(e)||[];p.set(e,[...r,t])}function j(e){for(let t of p.get(e)||[])e.deleteFramebuffer(t);p.set(e,[])}function k(e){let t=e.createFramebuffer();if(!t)throw new Error("Unable to create framebuffer");return M(e,t),t}function W(e,t,r,a){e.bindFramebuffer(e.FRAMEBUFFER,t),e.framebufferTexture2D(e.FRAMEBUFFER,r,e.TEXTURE_2D,a,0);const n=e.checkFramebufferStatus(e.FRAMEBUFFER);if(n!==e.FRAMEBUFFER_COMPLETE)throw new Error(`Framebuffer incomplete: 0x${n.toString(16)}`)}var m=new Map;function v(e,t){let r=m.get(e)||new Set;r.add(t),m.set(e,r)}function V(e){for(let t of m.get(e)||new Set)e.deleteTexture(t);m.set(e,new Set)}function $(e,t){e.deleteTexture(t);let r=m.get(e);r&&r.delete(t)}function Y(e,t,r,a,n,i,s=null,f={}){let u=e.createTexture();if(!u)throw new Error("Unable to create texture");e.bindTexture(e.TEXTURE_2D,u);const c=R(f,{[e.TEXTURE_WRAP_S]:e.REPEAT,[e.TEXTURE_WRAP_T]:e.REPEAT,[e.TEXTURE_MIN_FILTER]:e.NEAREST,[e.TEXTURE_MAG_FILTER]:e.NEAREST});for(const[E,d]of Object.entries(c))e.texParameteri(e.TEXTURE_2D,parseInt(E),d);return S(s),e.texImage2D(e.TEXTURE_2D,0,a,t,r,0,n,i,s),v(e,u),u}function z(e,t,r){e.activeTexture(t),e.bindTexture(e.TEXTURE_2D,r)}var L=(e,...t)=>e.map((r,a)=>`${r}${t[a]||""}`).join(""),D=L`#version 300 es

precision highp float;

void main() {
	float x = float((gl_VertexID & 1) << 2);
	float y = float((gl_VertexID & 2) << 1);
	gl_Position = vec4(x - 1.0, y - 1.0, 0, 1);
}
`,I=()=>({devicePixelRatio:window&&window.devicePixelRatio||1,context:{premultipliedAlpha:!1}});function H(e,t,r,a={}){const{devicePixelRatio:n,context:i}=R(I(),a),s=e.getContext("webgl2",i);if(!s)throw new Error("Unable to get WebGL context.");const f=A(s,t,r),{setResolution:u}=f;function c(d=!0){if(!s)return{};s.bindFramebuffer(s.FRAMEBUFFER,null),s.clearColor(0,0,0,0),s.clear(s.COLOR_BUFFER_BIT);const w=e.getBoundingClientRect(),h=e.width=w.width*n,l=e.height=w.height*n;return s.viewport(0,0,h,l),u([h,l]),d&&s.drawArrays(s.TRIANGLE_FAN,0,3),{width:h,height:l,ratio:h/l}}function E(){if(!s)return;let d=s.getExtension("WEBGL_lose_context");d&&d.loseContext()}return{...f,render:c,destroy:E}}function A(e,t,r){const a=T(e,e.VERTEX_SHADER,t),n=T(e,e.FRAGMENT_SHADER,r),i=y(e,a,n);if(!i)throw new Error("Unable to create shader program");const s=b(e,i,"2fv","resolution");return e.useProgram(i),{gl:e,program:i,vertex_shader:a,fragment_shader:n,createUniform:(f,u)=>b(e,i,f,u),createAttribute:f=>P(e,i,f),setResolution:s}}function K(e,t){return{...A(e,D,t),draw(){e.drawArrays(e.TRIANGLE_FAN,0,3)}}}var J=class{constructor(){o(this,"program_states",new Map);o(this,"program_inits",new Map);o(this,"program_updates",new Map);o(this,"program_renders",new Map);o(this,"program_destroys",new Map);o(this,"state",0);o(this,"last_loop_time",0);o(this,"update_speed",1);o(this,"update_time_step",16);o(this,"max_updates",200);o(this,"animation_frame");o(this,"accumulated_frame_time",0)}linkProgram(e){if(this.program_states.set(e,0),e.init){const t=async()=>{let r=e.init();(!r||!r.then)&&(r=Promise.resolve(r)),await r,this.program_states.set(e,1),e.update&&this.program_updates.set(e,e.update),e.render&&this.program_renders.set(e,e.render)};this.program_inits.set(e,t),[1,2].includes(this.state)&&t()}e.destroy&&this.program_destroys.set(e,()=>{this.program_states.get(e)==1&&(this.program_updates.delete(e),this.program_renders.delete(e),e.destroy(),this.program_states.set(e,2))})}unlinkProgram(e){this.program_states.delete(e),this.program_inits.delete(e),this.program_updates.delete(e),this.program_renders.delete(e),this.program_destroys.delete(e)}async init(){if([0,3].includes(this.state)){this.last_loop_time=performance.now(),this.state=1;try{await Promise.all(Array.from(this.program_inits.values()).map(e=>e()))}catch(e){throw console.log(e),new Error("Error initializing")}this.requestLoop()}}requestLoop(){this.animation_frame=requestAnimationFrame(this.loop.bind(this))}cancelLoop(){this.animation_frame&&cancelAnimationFrame(this.animation_frame)}loop(e){if([0,3].includes(this.state))return;if(this.state==1)for(this.accumulated_frame_time+=e-this.last_loop_time,Math.floor(this.accumulated_frame_time/this.update_time_step)>this.max_updates&&(this.accumulated_frame_time=this.update_time_step);this.accumulated_frame_time>=this.update_time_step;)this.update(this.update_time_step),this.accumulated_frame_time-=this.update_time_step;let t=this.accumulated_frame_time/this.update_time_step;this.render(t),this.last_loop_time=e,this.requestLoop()}update(e){this.program_updates.forEach(t=>t(e*this.update_speed))}render(e){this.program_renders.forEach(t=>t(e))}};function Q(e,t,r,a,n,i){const s=Array.from({length:16}),f=1/(e-t),u=1/(r-a),c=1/(n-i);return s[0]=-2*f,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=-2*u,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=2*c,s[11]=0,s[12]=(e+t)*f,s[13]=(a+r)*u,s[14]=(i+n)*c,s[15]=1,s}function Z(e){let t=Math.floor(Math.sqrt(e));for(let r of Array.from({length:t},(a,n)=>t-n))if(e%r==0)return[r,Math.floor(e/r)]}function g(e,t){let r=e.value;e.value=t.value,t.value=r}function ee(e,t,{flush:r="sync",deep:a=!1,immediate:n=!0}={}){return U(e,i=>{t(i)},{flush:r,deep:a,immediate:n})}export{J as L,K as a,z as b,O as c,G as d,Z as e,W as f,L as g,A as h,V as i,j,g as k,Y as l,k as m,$ as n,H as o,Q as p,q,N as r,ee as s};
